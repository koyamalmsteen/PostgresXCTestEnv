<project name="Postgres-XC Test Environment" default="all" basedir=".">
  <property file="build.properties"/>
  <property environment="env"/>
  <property name="hostname" value="${env.HOSTNAME}"/>
  <property name="home" value="${env.HOME}"/>

  <target name="all" depends="init, install"/>

  <target name="clean">
    <delete dir="/usr/local/pgsql"/>
  </target>

  <target name="init">
    <echo file="/etc/profile" message="#&#x0A;" append="yes"/>
    <echo file="/etc/profile" message="export PGLIB=/usr/local/pgsql/lib&#x0A;" append="yes"/>
    <echo file="/etc/profile" message="export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:$PGLIB&#x0A;" append="yes"/>
    <echo file="/etc/profile" message="export PATH=${PATH}:/usr/local/pgsql/bin&#x0A;" append="yes"/>
    <echo file="/etc/profile" message="export MANPATH=${MANPATH}:/usr/local/pgsql/man&#x0A;" append="yes"/>
    <echo file="/etc/profile" message="export PGDATA=/usr/local/pgsql/data&#x0A;" append="yes"/>
    <!-- -->
    <antcall target="clean"/>
    <!-- -->
    <exec executable="yum">
      <arg line="-y install gcc readline-devel zlib-devel flex bison"/>
    </exec>
    <mkdir dir="${src}"/>
    <get src="${src_postgres_xc}" dest="${dst_postgres_xc}" usetimestamp="true"/>
    <exec dir="${src}" executable="tar">
      <arg line="zxf ${postgres_xc}"/>
    </exec>
  </target>

  <target name="install">
    <exec executable="./configure" dir="${src}/pgxc">
      <arg line=""/>
    </exec>
    <exec executable="make" dir="${src}/pgxc">
      <arg line=""/>
    </exec>
    <exec executable="make" dir="${src}/pgxc">
      <arg line="install"/>
    </exec>
    <!-- -->
    <exec executable="adduser">
      <arg line="postgres"/>
    </exec>
    <!-- -->
    <mkdir dir="/usr/local/pgsql/data_coord1"/>
    <mkdir dir="/usr/local/pgsql/data_datanode1"/>
    <mkdir dir="/usr/local/pgsql/data_datanode2"/>
    <mkdir dir="/usr/local/pgsql/data_gtm"/>
    <!-- -->
    <exec executable="chown">
      <arg line="-R postgres.postgres /usr/local/pgsql/data_coord1"/>
    </exec>
    <exec executable="chown">
      <arg line="-R postgres.postgres /usr/local/pgsql/data_datanode1"/>
    </exec>
    <exec executable="chown">
      <arg line="-R postgres.postgres /usr/local/pgsql/data_datanode2"/>
    </exec>
    <exec executable="chown">
      <arg line="-R postgres.postgres /usr/local/pgsql/data_gtm"/>
    </exec>
    <!-- -->
    <exec executable="sudo">
      <arg line="-i -u postgres initdb -D /usr/local/pgsql/data_coord1 --no-locale --encoding=UTF-8 --nodename coord1"/>
    </exec>
    <exec executable="sudo">
      <arg line="-i -u postgres initdb -D /usr/local/pgsql/data_datanode1 --no-locale --encoding=UTF-8 --nodename datanode1"/>
    </exec>
    <exec executable="sudo">
      <arg line="-i -u postgres initdb -D /usr/local/pgsql/data_datanode2 --no-locale --encoding=UTF-8 --nodename datanode2"/>
    </exec>
    <exec executable="sudo">
      <arg line="-i -u postgres initgtm -D /usr/local/pgsql/data_gtm -Z gtm"/>
    </exec>
    <!-- -->
<!--
    <exec executable="sudo" spawn="true">
      <arg line="-i -u postgres gtm -D /usr/local/pgsql/data_gtm &gt;logfile 2&gt;&amp;1"/>
    </exec>
-->
    <exec executable="sudo">
      <arg line="-i -u postgres sh -c"/>
      <arg line="gtm -D /usr/local/pgsql/data_gtm &gt;logfile 2&gt;&amp;1"/>
    </exec>
    <!-- -->
    <echo message="HOGE"/>
    <exec executable="sudo">
      <arg line="-i -u postgres postgres -X -p 15432 -D /usr/local/pgsql/data_datanode1 &gt;logfile 2&gt;&amp;1"/>
    </exec>
    <echo message="-i -u postgres postgres -X -p 15432 -D /usr/local/pgsql/data_datanode1 &gt;logfile 2&gt;&amp;1"/>
    <echo message="HOGE2"/>
<!--
    <exec executable="sudo" spawn="true">
      <arg line="-i -u postgres postgres -X -p 15433 -D /usr/local/pgsql/data_datanode2 &gt;logfile 2&gt;&amp;1"/>
    </exec>
    <exec executable="sudo" spawn="true">
      <arg line="-i -u postgres postgres -C -D /usr/local/pgsql/data_coord1 &gt;logfile 2&gt;&amp;1"/>
    </exec>
-->
    <!-- -->
<!--
    <exec executable="sudo">
      <arg line="-i -u postgres psql -c &quot;CREATE NODE datanode1 WITH (TYPE=&apos;datanode&apos;, PORT=15432)&quot; postgres"/>
    </exec>
    <exec executable="sudo">
      <arg line="-i -u postgres psql -c &quot;CREATE NODE datanode2 WITH (TYPE=&apos;datanode&apos;, PORT=15433)&quot; postgres"/>
    </exec>
    <exec executable="sudo">
      <arg line="-i -u postgres psql -c &quot;SELECT pgxc_pool_reload()&quot; postgres"/>
    </exec>
-->
    <!-- -->
<!--
    <exec executable="sudo">
      <arg line="-i -u postgres createdb dspace"/>
    </exec>
-->
  </target>

</project>
